<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmos — MADvids</title>
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        @view-transition { navigation: auto; }
        :focus-visible { outline: 2px solid rgba(255,255,255,0.5); outline-offset: 2px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #050510;
            color: #fff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
        }

        /* ═══ LOADER ═══ */
        .loader {
            position: fixed; inset: 0; z-index: 9999;
            background: #050510;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 20px;
            transition: opacity 0.6s ease;
        }
        .loader.done { opacity: 0; pointer-events: none; }
        .loader-text {
            font-size: clamp(28px, 6vw, 44px);
            font-weight: 900;
            letter-spacing: -0.04em;
            color: rgba(255,255,255,0.08);
        }
        .loader-ring {
            width: 16px; height: 16px;
            border: 1.5px solid rgba(255,255,255,0.04);
            border-top-color: #b388ff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ═══ SHARED ═══ */
        .cosmos-wrap {
            position: fixed; inset: 0;
            overflow: hidden;
        }

        /* ═══ CANVAS LAYERS ═══ */
        #starfield, #connections, #particles {
            position: fixed; top: 0; left: 0;
            pointer-events: none;
        }
        #starfield { z-index: 1; }
        #connections { z-index: 4; }
        #particles { z-index: 6; mix-blend-mode: screen; }

        /* ═══ DESKTOP: PORTALS ═══ */
        .portals-layer {
            position: fixed; inset: 0; z-index: 5;
        }

        .portal {
            position: absolute;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            will-change: transform;
            transition: box-shadow 0.3s;
        }
        .portal video {
            width: 100%; height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .portal-glow {
            position: absolute; inset: -8px;
            border-radius: 50%;
            border: 2px solid transparent;
            pointer-events: none;
            will-change: opacity;
        }
        .portal-label {
            position: absolute;
            bottom: -32px; left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            text-shadow: 0 1px 8px rgba(0,0,0,0.8);
        }
        .portal:hover .portal-label { opacity: 1; }

        /* ═══ DESKTOP: IMMERSIVE VIEW ═══ */
        .immersive {
            position: fixed; inset: 0; z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s;
        }
        .immersive.active {
            pointer-events: auto;
            opacity: 1;
        }
        .immersive video {
            position: absolute; inset: 0;
            width: 100%; height: 100%;
            object-fit: cover;
        }
        .immersive-overlay {
            position: absolute; inset: 0;
            pointer-events: none;
        }
        .immersive-vignette {
            position: absolute; inset: 0;
            background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.6) 100%);
            pointer-events: none;
        }
        .immersive-text {
            position: absolute;
            bottom: 12%; left: 50%;
            transform: translateX(-50%);
            text-align: center;
            opacity: 0;
            transition: opacity 0.6s 0.3s, transform 0.6s 0.3s;
            transform: translateX(-50%) translateY(20px);
        }
        .immersive.active .immersive-text {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .immersive-text h2 {
            font-size: clamp(28px, 5vw, 56px);
            font-weight: 800;
            letter-spacing: -0.03em;
            text-shadow: 0 2px 20px rgba(0,0,0,0.6);
        }
        .immersive-text p {
            font-size: clamp(13px, 1.8vw, 18px);
            font-weight: 300;
            opacity: 0.6;
            margin-top: 8px;
            text-shadow: 0 1px 10px rgba(0,0,0,0.5);
        }
        .immersive-close {
            position: absolute;
            top: max(20px, env(safe-area-inset-top, 20px));
            right: max(20px, env(safe-area-inset-right, 20px));
            z-index: 51;
            width: 44px; height: 44px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .immersive-close:hover { background: rgba(255,255,255,0.2); }

        /* ═══ MOBILE: SWIPE CINEMA ═══ */
        .cinema {
            position: fixed; inset: 0; z-index: 5;
            overflow: hidden;
            display: none;
        }
        .cinema-track {
            position: absolute;
            width: 100%; height: 500dvh;
            will-change: transform;
        }
        .cinema-slide {
            position: relative;
            width: 100%; height: 100dvh;
            overflow: hidden;
        }
        .cinema-slide video {
            position: absolute; inset: 0;
            width: 100%; height: 100%;
            object-fit: cover;
        }
        .cinema-slide-overlay {
            position: absolute; inset: 0;
            pointer-events: none;
        }
        .cinema-slide-text {
            position: absolute;
            bottom: max(100px, calc(env(safe-area-inset-bottom, 20px) + 80px));
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            width: 90%;
        }
        .cinema-slide-text h2 {
            font-size: clamp(24px, 7vw, 40px);
            font-weight: 800;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 16px rgba(0,0,0,0.5);
        }
        .cinema-slide-text p {
            font-size: 0.85rem;
            font-weight: 300;
            opacity: 0.6;
            margin-top: 6px;
        }

        /* Dot navigation */
        .cinema-dots {
            position: fixed;
            bottom: max(24px, env(safe-area-inset-bottom, 24px));
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: none;
            gap: 12px;
            align-items: center;
        }
        .cinema-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.25);
            border: none;
            cursor: pointer;
            transition: background 0.3s, transform 0.3s, box-shadow 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        .cinema-dot.active {
            transform: scale(1.4);
            background: #fff;
        }

        /* ═══ AUDIO TOGGLE ═══ */
        .audio-btn {
            position: fixed;
            bottom: max(20px, env(safe-area-inset-bottom, 20px));
            right: max(20px, env(safe-area-inset-right, 20px));
            z-index: 60;
            width: 40px; height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s, color 0.2s;
        }
        .audio-btn:hover { background: rgba(255,255,255,0.12); color: #fff; }
        .audio-btn.on { color: #b388ff; }
        .audio-btn svg { width: 18px; height: 18px; }

        /* ═══ NAV VISIBILITY BOOST ═══ */
        #mv-nav {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.14);
        }
        #mv-nav .mv-btn { color: rgba(255,255,255,0.7); }
        #mv-nav .mv-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
        #mv-nav .mv-sep { background: rgba(255,255,255,0.12); }

        /* ═══ REDUCED MOTION ═══ */
        @media (prefers-reduced-motion: reduce) {
            .portal { transition: none; }
            .portal-label { transition: none; }
            .immersive { transition: none; }
            .immersive-text { transition: none; }
            .cinema-dot { transition: none; }
            .loader { transition: none; }
        }

        /* ═══ MOBILE DETECTION ═══ */
        @media (hover: none) and (pointer: coarse) {
            .portals-layer { display: none; }
            #connections { display: none; }
            .cinema { display: block; }
            .cinema-dots { display: flex; }
        }
        @media (hover: hover) and (pointer: fine) {
            .cinema { display: none; }
            .cinema-dots { display: none; }
            .portals-layer { display: block; }
        }
    </style>
</head>
<body>
    <div class="loader" id="loader">
        <div class="loader-text">Cosmos</div>
        <div class="loader-ring"></div>
    </div>

    <canvas id="starfield"></canvas>
    <canvas id="connections"></canvas>
    <canvas id="particles"></canvas>

    <!-- DESKTOP: Floating portals -->
    <div class="portals-layer" id="portalsLayer"></div>

    <!-- DESKTOP: Immersive view -->
    <div class="immersive" id="immersive">
        <video id="immersiveVideo" muted loop playsinline disablePictureInPicture></video>
        <div class="immersive-overlay" id="immersiveOverlay"></div>
        <div class="immersive-vignette"></div>
        <div class="immersive-text" id="immersiveText">
            <h2 id="immersiveTitle"></h2>
            <p id="immersiveTagline"></p>
        </div>
        <button class="immersive-close" id="immersiveClose" aria-label="Close">&times;</button>
    </div>

    <!-- MOBILE: Swipe cinema -->
    <div class="cinema" id="cinema">
        <div class="cinema-track" id="cinemaTrack"></div>
    </div>
    <div class="cinema-dots" id="cinemaDots"></div>

    <!-- Audio toggle -->
    <button class="audio-btn" id="audioBtn" aria-label="Toggle sound">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 5L6 9H2v6h4l5 4V5z"/>
            <path class="audio-waves" d="M15.54 8.46a5 5 0 010 7.07M19.07 4.93a10 10 0 010 14.14"/>
        </svg>
    </button>

    <script>
    (function() {
        'use strict';

        /* ─── CONFIG ─── */
        var BASE = '/MADvids/';
        var GCS_TEST = 'https://storage.googleapis.com/myproject-public-assets/ddn/videos/test/';
        var GCS_ART = 'https://storage.googleapis.com/myproject-public-assets/art/MADvids/';

        var WORLDS = [
            {
                name: 'Murakami Dream',
                tagline: 'Where flowers bloom in neon silence',
                color: '#ff6b9d',
                video: GCS_ART + 'Surreal_Murakami_Dreamscape_Video_Generation.mp4',
                preview: GCS_ART + 'Surreal_Murakami_Dreamscape_Video_Generation-preview.mp4',
                hue: 340, sat: 0.8
            },
            {
                name: 'Claude Pretty',
                tagline: 'Light refracted through digital prisms',
                color: '#4a9fff',
                video: GCS_TEST + 'claude-pretty-ugvuda.mp4',
                preview: GCS_TEST + 'claude-pretty-ugvuda-preview.mp4',
                hue: 215, sat: 0.7
            },
            {
                name: 'Neo Pop',
                tagline: 'A candy-colored flight through pop dreams',
                color: '#b388ff',
                video: GCS_ART + 'Neo_Pop_Dreamscape_Drone_Journey.mp4',
                preview: GCS_ART + 'Neo_Pop_Dreamscape_Drone_Journey-preview.mp4',
                hue: 265, sat: 0.75
            },
            {
                name: 'Gradient Liquid',
                tagline: 'Molten color pouring through space',
                color: '#e8a44a',
                video: GCS_ART + 'Surreal_Gradient_Liquid_Video_Generation.mp4',
                preview: GCS_ART + 'Surreal_Gradient_Liquid_Video_Generation-preview.mp4',
                hue: 35, sat: 0.7
            },
            {
                name: 'Cosmic Multiverse',
                tagline: 'Infinite realities in a single breath',
                color: '#ffc857',
                video: GCS_ART + 'Abstract_Multiverse_Cinematic_Journey_Generated.mp4',
                preview: GCS_ART + 'Abstract_Multiverse_Cinematic_Journey_Generated-preview.mp4',
                hue: 42, sat: 0.85
            }
        ];

        /* ?v= override */
        var vOverride = new URLSearchParams(location.search).get('v');
        if (vOverride) {
            WORLDS.forEach(function(w) {
                w.video = vOverride;
                w.preview = vOverride;
            });
        }

        var PORTAL_SIZE = 160;
        var reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        var isMobile = window.matchMedia('(hover: none) and (pointer: coarse)').matches;
        var dpr = Math.min(window.devicePixelRatio || 1, 2);
        var W = window.innerWidth;
        var H = window.innerHeight;

        window.addEventListener('resize', function() {
            W = window.innerWidth;
            H = window.innerHeight;
            resizeCanvases();
            if (!isMobile) computeHomePositions();
        }, { passive: true });

        /* ─── CANVAS SETUP ─── */
        var starCanvas = document.getElementById('starfield');
        var starCtx = starCanvas.getContext('2d');
        var connCanvas = document.getElementById('connections');
        var connCtx = connCanvas.getContext('2d');
        var partCanvas = document.getElementById('particles');
        var partCtx = partCanvas.getContext('2d');

        function resizeCanvases() {
            [starCanvas, connCanvas, partCanvas].forEach(function(c) {
                c.width = W * dpr;
                c.height = H * dpr;
                c.style.width = W + 'px';
                c.style.height = H + 'px';
                c.getContext('2d').setTransform(dpr, 0, 0, dpr, 0, 0);
            });
        }
        resizeCanvases();

        /* ─── STARFIELD ─── */
        var stars = [];
        for (var i = 0; i < 200; i++) {
            stars.push({
                x: Math.random() * W,
                y: Math.random() * H,
                r: Math.random() * 1.2 + 0.3,
                a: Math.random() * 0.5 + 0.15,
                dx: (Math.random() - 0.5) * 0.08,
                dy: (Math.random() - 0.5) * 0.08,
                phase: Math.random() * Math.PI * 2
            });
        }

        function drawStars(t) {
            starCtx.clearRect(0, 0, W, H);
            for (var i = 0; i < stars.length; i++) {
                var s = stars[i];
                s.x += s.dx;
                s.y += s.dy;
                if (s.x < 0) s.x = W;
                if (s.x > W) s.x = 0;
                if (s.y < 0) s.y = H;
                if (s.y > H) s.y = 0;
                var flicker = reducedMotion ? s.a : s.a + Math.sin(t * 0.001 + s.phase) * 0.15;
                starCtx.beginPath();
                starCtx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                starCtx.fillStyle = 'rgba(255,255,255,' + Math.max(0, flicker) + ')';
                starCtx.fill();
            }
        }

        /* ─── PARTICLES ─── */
        var particles = [];
        function spawnParticles(x, y, color, count) {
            if (reducedMotion) return;
            for (var i = 0; i < count; i++) {
                var angle = Math.random() * Math.PI * 2;
                var speed = Math.random() * 2 + 0.5;
                particles.push({
                    x: x, y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    r: Math.random() * 2.5 + 0.5,
                    life: 1,
                    decay: Math.random() * 0.015 + 0.01,
                    color: color
                });
            }
        }

        function drawParticles() {
            partCtx.clearRect(0, 0, W, H);
            for (var i = particles.length - 1; i >= 0; i--) {
                var p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.99;
                p.vy *= 0.99;
                p.life -= p.decay;
                if (p.life <= 0) { particles.splice(i, 1); continue; }
                partCtx.beginPath();
                partCtx.arc(p.x, p.y, p.r * p.life, 0, Math.PI * 2);
                partCtx.fillStyle = p.color.replace(')', ',' + (p.life * 0.6) + ')').replace('rgb', 'rgba');
                partCtx.fill();
            }
        }

        /* Helper: hex to rgb string */
        function hexToRgb(hex) {
            var r = parseInt(hex.slice(1, 3), 16);
            var g = parseInt(hex.slice(3, 5), 16);
            var b = parseInt(hex.slice(5, 7), 16);
            return 'rgb(' + r + ',' + g + ',' + b + ')';
        }

        /* ═══════════════════════════════════
           DESKTOP: FLOATING VIDEO PORTALS
           ═══════════════════════════════════ */

        var portals = [];
        var homePositions = [];
        var mouseX = W / 2, mouseY = H / 2;
        var mouseActive = false;
        var mouseIdleTimer = null;
        var immersiveOpen = false;
        var immersiveIdx = -1;
        var orbitAngle = 0;

        function computeHomePositions() {
            var cx = W / 2;
            var cy = H / 2;
            var radius = Math.min(W, H) * 0.28;
            homePositions = [];
            for (var i = 0; i < 5; i++) {
                var angle = -Math.PI / 2 + (i * 2 * Math.PI / 5);
                homePositions.push({
                    x: cx + Math.cos(angle) * radius,
                    y: cy + Math.sin(angle) * radius
                });
            }
        }
        computeHomePositions();

        if (!isMobile) {
            var layer = document.getElementById('portalsLayer');
            for (var i = 0; i < WORLDS.length; i++) {
                (function(idx) {
                    var w = WORLDS[idx];
                    var div = document.createElement('div');
                    div.className = 'portal';
                    div.style.width = PORTAL_SIZE + 'px';
                    div.style.height = PORTAL_SIZE + 'px';

                    var vid = document.createElement('video');
                    vid.muted = true;
                    vid.loop = true;
                    vid.playsInline = true;
                    vid.setAttribute('disablePictureInPicture', '');
                    vid.preload = 'auto';
                    vid.src = w.preview;
                    vid.play().catch(function() {});

                    var glow = document.createElement('div');
                    glow.className = 'portal-glow';

                    var label = document.createElement('div');
                    label.className = 'portal-label';
                    label.textContent = w.name;
                    label.style.color = w.color;

                    div.appendChild(vid);
                    div.appendChild(glow);
                    div.appendChild(label);
                    layer.appendChild(div);

                    div.addEventListener('mouseenter', function() {
                        spawnParticles(
                            portals[idx].x,
                            portals[idx].y,
                            hexToRgb(w.color),
                            8
                        );
                        pingSound(idx);
                    });

                    div.addEventListener('click', function() {
                        openImmersive(idx);
                    });

                    portals.push({
                        el: div,
                        vid: vid,
                        x: homePositions[idx].x,
                        y: homePositions[idx].y,
                        vx: 0,
                        vy: 0,
                        breathPhase: idx * 1.25
                    });
                })(i);
            }

            document.addEventListener('mousemove', function(e) {
                mouseX = e.clientX;
                mouseY = e.clientY;
                mouseActive = true;
                clearTimeout(mouseIdleTimer);
                mouseIdleTimer = setTimeout(function() { mouseActive = false; }, 3000);
            }, { passive: true });
        }

        /* ─── DESKTOP PHYSICS ─── */
        function updatePortals(t) {
            if (isMobile || immersiveOpen) return;

            var springK = 0.0003;
            var repulseR = PORTAL_SIZE * 1.3;
            var repulseK = 0.8;
            var mouseG = 0.15;
            var mouseRepulse = 80;
            var mouseAttract = 400;
            var damping = 0.96;

            if (!mouseActive) {
                orbitAngle += 0.0003;
            }

            for (var i = 0; i < portals.length; i++) {
                var p = portals[i];

                /* Home position (with idle orbit) */
                var hx = homePositions[i].x;
                var hy = homePositions[i].y;
                if (!mouseActive) {
                    var orbitR = 15;
                    hx += Math.cos(orbitAngle + i * 1.25) * orbitR;
                    hy += Math.sin(orbitAngle + i * 1.25) * orbitR;
                }

                /* Spring to home */
                p.vx += (hx - p.x) * springK;
                p.vy += (hy - p.y) * springK;

                /* Inter-portal repulsion */
                for (var j = 0; j < portals.length; j++) {
                    if (i === j) continue;
                    var dx = p.x - portals[j].x;
                    var dy = p.y - portals[j].y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < repulseR && dist > 0) {
                        var force = repulseK * (repulseR - dist) / repulseR;
                        p.vx += (dx / dist) * force;
                        p.vy += (dy / dist) * force;
                    }
                }

                /* Mouse gravity */
                if (mouseActive) {
                    var mdx = mouseX - p.x;
                    var mdy = mouseY - p.y;
                    var mDist = Math.sqrt(mdx * mdx + mdy * mdy);
                    if (mDist < mouseAttract && mDist > 0) {
                        if (mDist < mouseRepulse) {
                            /* Repulsion when too close */
                            var rep = (mouseRepulse - mDist) / mouseRepulse * 0.8;
                            p.vx -= (mdx / mDist) * rep;
                            p.vy -= (mdy / mDist) * rep;
                        } else {
                            /* Gentle pull */
                            var pull = mouseG * (1 - mDist / mouseAttract);
                            pull = Math.min(pull, 0.5);
                            p.vx += (mdx / mDist) * pull;
                            p.vy += (mdy / mDist) * pull;
                        }
                    }
                }

                /* Damping */
                p.vx *= damping;
                p.vy *= damping;

                /* Update position */
                p.x += p.vx;
                p.y += p.vy;

                /* Soft wall boundaries */
                var pad = PORTAL_SIZE / 2 + 20;
                if (p.x < pad) { p.x = pad; p.vx *= -0.5; }
                if (p.x > W - pad) { p.x = W - pad; p.vx *= -0.5; }
                if (p.y < pad) { p.y = pad; p.vy *= -0.5; }
                if (p.y > H - pad) { p.y = H - pad; p.vy *= -0.5; }

                /* Breathing */
                var breath = reducedMotion ? 1 : 0.96 + 0.04 * Math.sin(t * 0.0015 + p.breathPhase);

                /* Apply transform */
                p.el.style.transform = 'translate3d(' +
                    (p.x - PORTAL_SIZE / 2) + 'px,' +
                    (p.y - PORTAL_SIZE / 2) + 'px, 0) scale(' + breath + ')';

                /* Glow ring — static box-shadow, only opacity animated (compositor-friendly) */
                var glowEl = p.el.querySelector('.portal-glow');
                var glowPulse = reducedMotion ? 0.4 : 0.3 + 0.15 * Math.sin(t * 0.002 + i * 1.5);
                if (!glowEl._init) {
                    glowEl.style.borderColor = WORLDS[i].color;
                    glowEl.style.boxShadow = '0 0 20px rgba(' +
                        parseInt(WORLDS[i].color.slice(1, 3), 16) + ',' +
                        parseInt(WORLDS[i].color.slice(3, 5), 16) + ',' +
                        parseInt(WORLDS[i].color.slice(5, 7), 16) + ',0.4)';
                    glowEl._init = true;
                }
                glowEl.style.opacity = glowPulse;
            }
        }

        /* ─── CONNECTION LINES ─── */
        function drawConnections() {
            if (isMobile || immersiveOpen) return;
            connCtx.clearRect(0, 0, W, H);
            var maxDist = 350;
            for (var i = 0; i < portals.length; i++) {
                for (var j = i + 1; j < portals.length; j++) {
                    var dx = portals[i].x - portals[j].x;
                    var dy = portals[i].y - portals[j].y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < maxDist) {
                        var alpha = (1 - dist / maxDist) * 0.12;
                        connCtx.beginPath();
                        connCtx.moveTo(portals[i].x, portals[i].y);
                        connCtx.lineTo(portals[j].x, portals[j].y);
                        connCtx.strokeStyle = 'rgba(255,255,255,' + alpha + ')';
                        connCtx.lineWidth = 0.8;
                        connCtx.stroke();
                    }
                }
            }
        }

        /* ─── IMMERSIVE VIEW ─── */
        var immersiveEl = document.getElementById('immersive');
        var immersiveVid = document.getElementById('immersiveVideo');
        var immersiveOverlay = document.getElementById('immersiveOverlay');
        var immersiveTitle = document.getElementById('immersiveTitle');
        var immersiveTagline = document.getElementById('immersiveTagline');
        var immersiveCloseBtn = document.getElementById('immersiveClose');

        function openImmersive(idx) {
            immersiveOpen = true;
            immersiveIdx = idx;
            var w = WORLDS[idx];

            immersiveVid.src = w.video;
            immersiveVid.play().catch(function() {});
            immersiveOverlay.style.background =
                'linear-gradient(135deg, ' + w.color + '22 0%, transparent 60%)';
            immersiveTitle.textContent = w.name;
            immersiveTitle.style.color = w.color;
            immersiveTagline.textContent = w.tagline;

            /* Stagger portal fade-out */
            portals.forEach(function(p, i) {
                setTimeout(function() {
                    p.el.style.opacity = '0';
                    p.el.style.transition = 'opacity 0.3s';
                }, i * 60);
            });

            setTimeout(function() {
                immersiveEl.classList.add('active');
            }, 200);

            spawnParticles(portals[idx].x, portals[idx].y, hexToRgb(w.color), 25);
            expandSound(idx);
            setDroneWorld(idx);
        }

        function closeImmersive() {
            if (!immersiveOpen) return;
            immersiveEl.classList.remove('active');
            collapseSound();

            setTimeout(function() {
                immersiveOpen = false;
                immersiveIdx = -1;
                immersiveVid.pause();
                immersiveVid.removeAttribute('src');
                immersiveVid.load();

                portals.forEach(function(p) {
                    p.el.style.opacity = '1';
                    p.el.style.transition = 'opacity 0.4s';
                });
            }, 400);
        }

        immersiveCloseBtn.addEventListener('click', closeImmersive);
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && immersiveOpen) closeImmersive();
        });

        /* ═══════════════════════════════════
           MOBILE: SWIPEABLE CINEMA
           ═══════════════════════════════════ */

        var cinemaTrack = document.getElementById('cinemaTrack');
        var cinemaDots = document.getElementById('cinemaDots');
        var currentSlide = 0;
        var trackOffset = 0;
        var touchStartY = 0;
        var touchStartTime = 0;
        var touching = false;
        var cinemaVideos = [];

        /* Clip-path reveals per world */
        var clipPaths = [
            function(p) { var r = p * 72; return 'circle(' + r + '% at 50% 50%)'; },
            function(p) { var r = p * 72; return 'circle(' + r + '% at 50% 50%)'; },
            function(p) {
                var s = (1 - p) * 50;
                return 'polygon(' + s + '% 0%, ' + (100 - s) + '% 0%, 100% ' + s + '%, 100% ' + (100 - s) + '%, ' + (100 - s) + '% 100%, ' + s + '% 100%, 0% ' + (100 - s) + '%, 0% ' + s + '%)';
            },
            function(p) { var s = (1 - p) * 50; return 'inset(' + s + '% 0%)'; },
            function(p) { var s = (1 - p) * 50; return 'inset(0% ' + s + '%)'; }
        ];

        if (isMobile) {
            /* Build slides */
            for (var i = 0; i < WORLDS.length; i++) {
                (function(idx) {
                    var w = WORLDS[idx];
                    var slide = document.createElement('div');
                    slide.className = 'cinema-slide';

                    var vid = document.createElement('video');
                    vid.muted = true;
                    vid.loop = true;
                    vid.playsInline = true;
                    vid.setAttribute('disablePictureInPicture', '');
                    vid.preload = idx < 2 ? 'auto' : 'none';
                    if (idx < 2) vid.src = w.preview;

                    var overlay = document.createElement('div');
                    overlay.className = 'cinema-slide-overlay';
                    overlay.style.background =
                        'linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 40%)';

                    var text = document.createElement('div');
                    text.className = 'cinema-slide-text';
                    text.innerHTML = '<h2 style="color:' + w.color + '">' + w.name + '</h2>' +
                        '<p>' + w.tagline + '</p>';

                    slide.appendChild(vid);
                    slide.appendChild(overlay);
                    slide.appendChild(text);
                    cinemaTrack.appendChild(slide);
                    cinemaVideos.push(vid);

                    /* Dot */
                    var dot = document.createElement('button');
                    dot.className = 'cinema-dot' + (idx === 0 ? ' active' : '');
                    dot.setAttribute('aria-label', w.name);
                    dot.style.setProperty('--dot-color', w.color);
                    dot.addEventListener('click', function() { goToSlide(idx); });
                    cinemaDots.appendChild(dot);
                })(i);
            }

            /* Start first video */
            if (cinemaVideos[0]) {
                cinemaVideos[0].play().catch(function() {});
            }

            /* Touch handling */
            var cinemaEl = document.getElementById('cinema');
            cinemaEl.addEventListener('touchstart', function(e) {
                touching = true;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
                cinemaTrack.style.transition = 'none';
            }, { passive: true });

            cinemaEl.addEventListener('touchmove', function(e) {
                if (!touching) return;
                var dy = e.touches[0].clientY - touchStartY;
                var slideH = H;
                var base = -currentSlide * slideH;
                var offset = base + dy;

                /* Rubber-band at edges */
                if (currentSlide === 0 && dy > 0) {
                    offset = base + dy * 0.3;
                } else if (currentSlide === WORLDS.length - 1 && dy < 0) {
                    offset = base + dy * 0.3;
                }

                trackOffset = offset;
                cinemaTrack.style.transform = 'translate3d(0,' + offset + 'px,0)';

                /* Touch particle ripple */
                spawnParticles(
                    e.touches[0].clientX,
                    e.touches[0].clientY,
                    hexToRgb(WORLDS[currentSlide].color),
                    3
                );
            }, { passive: true });

            cinemaEl.addEventListener('touchend', function(e) {
                if (!touching) return;
                touching = false;
                var dy = (e.changedTouches ? e.changedTouches[0].clientY : touchStartY) - touchStartY;
                var dt = Date.now() - touchStartTime;
                var velocity = Math.abs(dy) / dt;
                var threshold = 50;

                if (Math.abs(dy) > threshold || velocity > 0.3) {
                    if (dy < 0 && currentSlide < WORLDS.length - 1) {
                        goToSlide(currentSlide + 1);
                    } else if (dy > 0 && currentSlide > 0) {
                        goToSlide(currentSlide - 1);
                    } else {
                        goToSlide(currentSlide);
                    }
                } else {
                    goToSlide(currentSlide);
                }
            }, { passive: true });
        }

        function goToSlide(idx) {
            var prev = currentSlide;
            currentSlide = idx;
            var slideH = H;
            trackOffset = -idx * slideH;
            cinemaTrack.style.transition = 'transform 0.6s cubic-bezier(0.16, 1, 0.3, 1)';
            cinemaTrack.style.transform = 'translate3d(0,' + trackOffset + 'px,0)';

            /* Update dots */
            var dots = cinemaDots.querySelectorAll('.cinema-dot');
            dots.forEach(function(d, i) {
                d.classList.toggle('active', i === idx);
                if (i === idx) {
                    d.style.boxShadow = '0 0 8px ' + WORLDS[i].color;
                } else {
                    d.style.boxShadow = 'none';
                }
            });

            /* Video management: load current + adjacent, unload far */
            for (var i = 0; i < WORLDS.length; i++) {
                var vid = cinemaVideos[i];
                if (!vid) continue;
                if (Math.abs(i - idx) <= 1) {
                    if (!vid.src) vid.src = WORLDS[i].preview;
                    if (i === idx) {
                        vid.play().catch(function() {});
                    } else {
                        vid.pause();
                    }
                } else {
                    vid.pause();
                    vid.removeAttribute('src');
                    vid.load();
                }
            }

            /* Clip-path reveal animation */
            if (!reducedMotion && prev !== idx) {
                var slide = cinemaTrack.children[idx];
                var vidEl = slide.querySelector('video');
                if (vidEl && clipPaths[idx]) {
                    vidEl.style.clipPath = clipPaths[idx](0);
                    var start = performance.now();
                    var dur = 700;
                    function animClip(now) {
                        var p = Math.min((now - start) / dur, 1);
                        /* Ease out */
                        var ep = 1 - Math.pow(1 - p, 3);
                        vidEl.style.clipPath = clipPaths[idx](ep);
                        if (p < 1) requestAnimationFrame(animClip);
                    }
                    requestAnimationFrame(animClip);
                }
            }

            if (prev !== idx) {
                swipeSound(idx);
                setDroneWorld(idx);
            }
        }

        /* ═══════════════════════════════════
           WEB AUDIO
           ═══════════════════════════════════ */

        var audioCtx = null;
        var audioOn = false;
        var droneGain = null;
        var droneFilter = null;
        var droneOscs = [];

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            /* Master */
            droneGain = audioCtx.createGain();
            droneGain.gain.value = 0;
            droneFilter = audioCtx.createBiquadFilter();
            droneFilter.type = 'lowpass';
            droneFilter.frequency.value = 300;
            droneFilter.Q.value = 1;

            droneFilter.connect(droneGain);
            droneGain.connect(audioCtx.destination);

            /* 3 detuned oscillators */
            var freqs = [55, 55.3, 82.4];
            freqs.forEach(function(f) {
                var osc = audioCtx.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = f;
                var g = audioCtx.createGain();
                g.gain.value = 0.12;
                osc.connect(g);
                g.connect(droneFilter);
                osc.start();
                droneOscs.push({ osc: osc, gain: g });
            });
        }

        function toggleAudio() {
            if (!audioCtx) initAudio();
            audioOn = !audioOn;
            var btn = document.getElementById('audioBtn');
            btn.classList.toggle('on', audioOn);

            if (audioCtx.state === 'suspended') audioCtx.resume();

            var now = audioCtx.currentTime;
            droneGain.gain.cancelScheduledValues(now);
            droneGain.gain.setValueAtTime(droneGain.gain.value, now);
            droneGain.gain.linearRampToValueAtTime(audioOn ? 0.18 : 0, now + 0.5);
        }

        document.getElementById('audioBtn').addEventListener('click', toggleAudio);

        function setDroneWorld(idx) {
            if (!audioCtx || !audioOn) return;
            var w = WORLDS[idx];
            var now = audioCtx.currentTime;
            /* Modulate filter based on world hue */
            var freq = 200 + (w.hue / 360) * 600;
            droneFilter.frequency.cancelScheduledValues(now);
            droneFilter.frequency.setValueAtTime(droneFilter.frequency.value, now);
            droneFilter.frequency.linearRampToValueAtTime(freq, now + 1);
        }

        /* Pentatonic ping */
        var pentatonic = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25, 587.33];
        function pingSound(worldIdx) {
            if (!audioCtx || !audioOn) return;
            var now = audioCtx.currentTime;
            var osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.value = pentatonic[worldIdx % pentatonic.length];
            var g = audioCtx.createGain();
            g.gain.setValueAtTime(0.08, now);
            g.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
            osc.connect(g);
            g.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + 0.15);
        }

        /* Expand arpeggio */
        function expandSound(worldIdx) {
            if (!audioCtx || !audioOn) return;
            var now = audioCtx.currentTime;
            var notes = [pentatonic[worldIdx % 5], pentatonic[(worldIdx + 2) % 5] * 1.5, pentatonic[(worldIdx + 4) % 5] * 2];
            notes.forEach(function(f, i) {
                var osc = audioCtx.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = f;
                var g = audioCtx.createGain();
                g.gain.setValueAtTime(0, now + i * 0.08);
                g.gain.linearRampToValueAtTime(0.06, now + i * 0.08 + 0.02);
                g.gain.exponentialRampToValueAtTime(0.001, now + i * 0.08 + 0.2);
                osc.connect(g);
                g.connect(audioCtx.destination);
                osc.start(now + i * 0.08);
                osc.stop(now + i * 0.08 + 0.2);
            });
        }

        /* Collapse */
        function collapseSound() {
            if (!audioCtx || !audioOn) return;
            var now = audioCtx.currentTime;
            var notes = [523.25, 392.00, 261.63];
            notes.forEach(function(f, i) {
                var osc = audioCtx.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = f;
                var g = audioCtx.createGain();
                g.gain.setValueAtTime(0, now + i * 0.06);
                g.gain.linearRampToValueAtTime(0.05, now + i * 0.06 + 0.02);
                g.gain.exponentialRampToValueAtTime(0.001, now + i * 0.06 + 0.18);
                osc.connect(g);
                g.connect(audioCtx.destination);
                osc.start(now + i * 0.06);
                osc.stop(now + i * 0.06 + 0.18);
            });
        }

        /* Swipe whoosh */
        function swipeSound(worldIdx) {
            if (!audioCtx || !audioOn) return;
            var now = audioCtx.currentTime;
            var osc = audioCtx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.exponentialRampToValueAtTime(80, now + 0.15);
            var g = audioCtx.createGain();
            g.gain.setValueAtTime(0.04, now);
            g.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
            var filt = audioCtx.createBiquadFilter();
            filt.type = 'lowpass';
            filt.frequency.value = 600;
            osc.connect(filt);
            filt.connect(g);
            g.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + 0.15);
        }

        /* ═══════════════════════════════════
           MAIN LOOP
           ═══════════════════════════════════ */

        var running = true;
        var loopRafId = null;
        function loop(t) {
            if (!running) return;
            drawStars(t);
            if (!isMobile) {
                updatePortals(t);
                drawConnections();
            }
            drawParticles();
            loopRafId = requestAnimationFrame(loop);
        }

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                running = false;
                if (loopRafId) { cancelAnimationFrame(loopRafId); loopRafId = null; }
            } else {
                running = true;
                if (!loopRafId) loopRafId = requestAnimationFrame(loop);
            }
        });

        /* ─── LOADER ─── */
        var loader = document.getElementById('loader');
        function dismissLoader() {
            loader.classList.add('done');
            setTimeout(function() { loader.remove(); }, 600);
            requestAnimationFrame(loop);
        }

        /* Wait for first video or timeout */
        if (!isMobile && portals.length > 0) {
            var firstVid = portals[0].vid;
            if (firstVid.readyState >= 2) {
                setTimeout(dismissLoader, 300);
            } else {
                firstVid.addEventListener('loadeddata', function() {
                    setTimeout(dismissLoader, 300);
                }, { once: true });
            }
        } else if (isMobile && cinemaVideos.length > 0) {
            var firstCVid = cinemaVideos[0];
            if (firstCVid.readyState >= 2) {
                setTimeout(dismissLoader, 300);
            } else {
                firstCVid.addEventListener('loadeddata', function() {
                    setTimeout(dismissLoader, 300);
                }, { once: true });
            }
        } else {
            setTimeout(dismissLoader, 300);
        }
        /* Max timeout */
        setTimeout(dismissLoader, 4000);

        /* ─── rAF LOOP FADE FOR ALL PORTAL VIDEOS ─── */
        function initLoopFade(v) {
            var fadeDur = 0.5;
            function tick() {
                if (v.paused) return;
                if (v.duration) {
                    var rem = v.duration - v.currentTime;
                    var o = 1;
                    if (rem < fadeDur) o = rem / fadeDur;
                    else if (v.currentTime < fadeDur) o = Math.min(v.currentTime / fadeDur, 1);
                    v.style.opacity = o;
                }
                requestAnimationFrame(tick);
            }
            v.addEventListener('play', function() { requestAnimationFrame(tick); });
        }

        portals.forEach(function(p) { initLoopFade(p.vid); });
        cinemaVideos.forEach(function(v) { initLoopFade(v); });
        initLoopFade(immersiveVid);

        /* ─── SERVICE WORKER ─── */
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(BASE + 'sw.js').catch(function() {});
        }
    })();
    </script>
    <script src="/MADvids/nav.js"></script>
</body>
</html>
